<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸµ è‡ªåŠ¨æ’æ­Œå·¥å…·</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f7; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        input, textarea { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; text-align: left;}
        button { width: 100%; padding: 12px; background: #e03e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:disabled { background: #ccc; }
        .hint { font-size: 12px; color: #666; margin-bottom: 20px; text-align: left; }
        
        /* æ‰«ç ç™»å½•æ ·å¼ */
        #qr-container { margin: 20px 0; display: none; }
        #qr-img { width: 180px; height: 180px; border: 1px solid #eee; }
        .login-btn { background: #333; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸµ è‡ªåŠ¨æ’æ­Œå·¥å…·</h2>
        <p class="hint">è¯·å…ˆæ‰«ç ç™»å½•ï¼Œå†è¾“å…¥æ­Œå•ä¿¡æ¯ã€‚</p>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div id="login-section">
            <button class="login-btn" onclick="startLogin()">ä½¿ç”¨ç½‘æ˜“äº‘ App æ‰«ç ç™»å½•</button>
            <div id="qr-container">
                <img id="qr-img" src="" alt="äºŒç»´ç ">
                <p id="qr-status" style="font-size: 14px; color: #666;">ç­‰å¾…æ‰«ç ...</p>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <!-- ä¸šåŠ¡åŒºåŸŸ -->
        <textarea id="ids" rows="4" placeholder="ç²˜è´´æ­Œå•é“¾æ¥æˆ–IDï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰"></textarea>
        <input type="number" id="duration" placeholder="ç›®æ ‡æ€»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰">
        <input type="text" id="cookie" placeholder="ç™»å½•åè‡ªåŠ¨å¡«å…… Cookie" readonly>
        
        <button id="gen-btn" onclick="generate()" disabled>è¯·å…ˆå®Œæˆç™»å½•</button>
        <p id="status" style="font-size: 14px; margin-top: 10px;"></p>
    </div>

    <script>
        let timer = null;

        // --- ç™»å½•é€»è¾‘ ---
        async function startLogin() {
            const qrContainer = document.getElementById('qr-container');
            const qrImg = document.getElementById('qr-img');
            const qrStatus = document.getElementById('qr-status');
            
            qrContainer.style.display = 'block';
            qrStatus.innerText = 'æ­£åœ¨åŠ è½½äºŒç»´ç ...';

            // 1. è·å– Key
            const keyRes = await fetch('/api/login/key');
            const { data: { unikey } } = await keyRes.json();

            // 2. è·å–äºŒç»´ç å›¾ç‰‡
            const imgRes = await fetch(`/api/login/create?key=${unikey}`);
            const { data: { qrimg } } = await imgRes.json();
            qrImg.src = qrimg;
            qrStatus.innerText = 'è¯·æ‰“å¼€ç½‘æ˜“äº‘ App æ‰«ç ';

            // 3. è½®è¯¢æ£€æŸ¥çŠ¶æ€
            if (timer) clearInterval(timer);
            timer = setInterval(async () => {
                const checkRes = await fetch(`/api/login/check?key=${unikey}`);
                const statusData = await checkRes.json();

                if (statusData.code === 800) {
                    qrStatus.innerText = 'äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°';
                    clearInterval(timer);
                } else if (statusData.code === 802) {
                    qrStatus.innerText = 'æ‰«ç æˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤';
                } else if (statusData.code === 803) {
                    // ç™»å½•æˆåŠŸï¼
                    qrStatus.innerText = 'âœ… ç™»å½•æˆåŠŸï¼';
                    clearInterval(timer);
                    document.getElementById('cookie').value = statusData.cookie;
                    document.getElementById('gen-btn').disabled = false;
                    document.getElementById('gen-btn').innerText = 'ç«‹å³ç”Ÿæˆæ–°æ­Œå•';
                    qrContainer.style.display = 'none';
                }
            }, 3000);
        }

        // --- æ’æ­Œé€»è¾‘ ---
        async function generate() {
            const btn = document.getElementById('gen-btn');
            const status = document.getElementById('status');
            const idsValue = document.getElementById('ids').value;
            const duration = document.getElementById('duration').value;
            const cookie = document.getElementById('cookie').value;

            if(!idsValue || !duration || !cookie) return alert('è¯·å¡«å…¨ä¿¡æ¯');
            const ids = idsValue.split('\n').filter(i => i.trim());

            btn.disabled = true; status.innerText = 'æ­£åœ¨æ’æ­Œï¼Œè¯·ç¨å€™...';
            
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playlistIds: ids, duration: parseInt(duration), cookie })
                });
                const data = await res.json();
                if(data.success) status.innerText = 'âœ… ç”ŸæˆæˆåŠŸï¼è¯·æŸ¥çœ‹ç½‘æ˜“äº‘ Appã€‚';
                else status.innerText = 'âŒ å¤±è´¥ï¼š' + data.message;
            } catch(e) { status.innerText = 'âŒ å‘ç”Ÿé”™è¯¯'; }
            btn.disabled = false;
        }
    </script>
</body>
</html>
